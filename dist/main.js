"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var jwt=require("jsonwebtoken"),request=require("request");function verifyJWT(e){var t=JSON.parse(e),r=t.authLevel,n=t.openidPublicKey,o=t.openidEndpoint;if(!t.enabled)return function(e,t,r){return r()};switch(r){case 1:return verifyWithOpenIDJwtToken(n);case 2:return verifyWithOpenIDEndpoint(o);default:return function(e,t){return t.status(500).json({error:"Server Internal Error"})}}}function verifyWithOpenIDJwtToken(u){return function(e,r,n){""!==u&&"undefined"!==u&&null!==u||r.status(400).json({error:"Bad request"});var t,o="-----BEGIN PUBLIC KEY-----\n".concat(u,"\n-----END PUBLIC KEY-----");e.headers.authorization?(""!==(t=e.headers.authorization.split(" ")[1])&&"undefined"!==t&&null!==t||r.status(400).json({error:"Bad Request"}),jwt.verify(t,o,function(e,t){e&&r.status(401).json({error:"Unauthorized"}),"object"===_typeof(t)&&t.preferred_username&&1e3*t.exp>=Date.now()?n():r.status(401).json({error:"Unauthorized"})})):r.status(400).json({error:"Bad Request"})}}function verifyWithOpenIDEndpoint(o){return function(e,r,n){var t;""!==o&&"undefined"!==o&&null!==o||r.status(400).json({error:"Bad request"}),e.headers.authorization?(t={method:"post",url:o,headers:{"Content-Type":"application/x-www-form-urlencoded",Authorization:e.headers.authorization},strictSSL:!1,form:{}},request(t,function(e,t){e&&r.status(401).json({error:"Unauthorized"}),200===t.statusCode?n():r.status(401).json({error:"Unauthorized"})})):r.status(400).json({error:"Bad Request"})}}module.exports.verifyJWT=verifyJWT,module.exports.verifyWithOpenIDJwtToken=verifyWithOpenIDJwtToken,module.exports.verifyWithOpenIDEndpoint=verifyWithOpenIDEndpoint;
//# sourceMappingURL=main.js.map
